{{ define "main" }}

{{/* Resolve publication type labels */}}
{{ $pub_type_csl := "" }}
{{ $pub_type_display := "" }}
{{ if .Params.publication_types }}
  {{ if reflect.IsSlice .Params.publication_types }}
    {{ $pub_type_csl = index .Params.publication_types 0 }}
    {{ $pub_type_display = i18n (printf "pub_%s" (strings.Replace $pub_type_csl "-" "_")) | default (strings.Title $pub_type_csl) }}
  {{ end }}
{{ end }}

<div class="mx-auto flex max-w-screen">
  {{ partial "components/sidebar.html" (dict "context" . "no_sidebar" true) }}
  {{ partial "components/toc.html" . }}

  <article class="w-full flex min-h-[calc(100vh-var(--navbar-height))] min-w-0 justify-center pb-8">
    <!-- Align main column to your reference block -->
    <main class="w-full min-w-0 max-w-5xl mx-auto px-4 py-4 mb-8 last:mb-0">

      {{ if .Params.show_breadcrumb }}
        <div class="mb-4">
          {{ partial "components/breadcrumb.html" . }}
        </div>
      {{ end }}

      <h1 class="mb-4 text-4xl font-bold tracking-tight text-gray-900 dark:text-white">
        {{- .Title -}}
      </h1>

      <!-- Meta row: date 路 authors 路 reading time (authors comma + space) -->
      {{- $authors := .GetTerms "authors" -}}
<div class="text-gray-500 dark:text-gray-300 text-sm flex items-center flex-wrap gap-x-2 gap-y-2 mb-8">

  {{- if .Date | and (not .Params.hide_date) -}}
    <span>{{ .Date | time.Format (site.Params.locale.date_format | default ":date_long") }}</span>
  {{- end -}}

  {{- if $authors -}}
    {{ if .Date }}<span aria-hidden="true" class="inline-block px-2">路</span>{{ end }}
    <span class="flex flex-wrap items-center">
      {{- range $i, $author_obj := $authors -}}
        {{- $author_page := $author_obj.Page -}}
        {{- $avatar := ($author_page.Resources.ByType "image").GetMatch "*avatar*" -}}
        <span class="inline-flex items-center gap-x-1">
          {{- with $avatar -}}
            {{- $a := .Process "Fill 50x50 Center webp" -}}
            <img src="{{ $a.RelPermalink }}" alt="{{ $author_page.Title }}" class="h-4 w-4 rounded-full border border-current" loading="lazy" />
          {{- end -}}
          {{- with $author_page.Params.website -}}
            <a href="{{ . }}" target="_blank" rel="noreferrer" class="hover:underline">{{ $author_page.Title }}</a>
          {{- else -}}
            <a href="{{ $author_page.RelPermalink }}" class="hover:underline">{{ $author_page.Title }}</a>
          {{- end -}}
        </span>
        {{- if lt (add $i 1) (len $authors) -}}<span>,&nbsp;</span>{{- end -}}
      {{- end -}}
    </span>
  {{- end -}}

  {{- if ne .Params.reading_time false -}}
    <span aria-hidden="true" class="inline-block px-2">路</span>
    <span>{{ .ReadingTime }} {{ i18n "minute_read" }}</span>
  {{- end -}}

</div>


      <div class="mt-3 mb-8">
        {{ partial "page_links_div.html" . }}
      </div>

      {{/* Featured image layout (keep logic, tighten margins to match rhythm) */}}
      {{ $featured := partial "functions/get_featured_image.html" . }}
      {{ if and $featured (not .Params.image.preview_only) }}
        {{ $image := $featured }}
        {{ $placement := .Params.image.placement | default 1 }}
        {{ $image_container := "" }}
        {{ if eq $placement 2 }}
          {{ $image_container = "container" }}
          {{ $image = $featured.Fit "1200x2500" }}
        {{ else if eq $placement 3 }}
          {{ $image_container = "container-fluid" }}
          {{ $image = $featured.Fit "2560x2560" }}
        {{ else }}
          {{ $image_container = "article-container" }}
          {{ $image = $featured.Fit "720x2500" }}
        {{ end }}
        {{ if ne $image.MediaType.SubType "gif" }}{{ $image = $image.Process "webp" }}{{ end }}
        <div class="featured-image-wrapper mt-4 mb-8" style="max-width: {{ $image.Width }}px; max-height: {{ $image.Height }}px;">
          <div style="position: relative">
            <img src="{{ $image.RelPermalink }}" width="{{ $image.Width }}" height="{{ $image.Height }}" alt="{{ with $.Params.image.alt_text }}{{.}}{{ end }}" class="featured-image">
            {{ with $.Params.image.caption }}<span class="article-header-caption">{{ . | markdownify | emojify }}</span>{{ end }}
          </div>
        </div>
      {{ end }}

      {{/* EVENT / PUBLICATION METADATA */}}
      {{ if .Params.abstract | or (eq .Type "publication") | or (eq .Type "event") }}
        <div class="grid grid-cols-1 md:grid-cols-[200px_auto] gap-4 my-6">
          {{ if .Params.abstract }}
            <div class="font-bold text-2xl">{{ i18n "abstract" }}</div>
            <div>{{ .Params.abstract | markdownify }}</div>
          {{ end }}

          {{ if $pub_type_display }}
            <div class="font-bold text-2xl">{{ i18n "publication_type" }}</div>
            <div>
              <a href="{{ range first 1 (.GetTerms "publication_types") }}{{ .RelPermalink }}{{ end }}">{{ $pub_type_display }}</a>
            </div>
          {{ end }}

          {{ if .Params.publication }}
            <div class="font-bold text-2xl">{{ i18n "publication" }}</div>
            <div>{{ .Params.publication | markdownify }}</div>
          {{ end }}

          {{ if eq .Type "event" }}
            <div class="font-bold text-2xl">{{ i18n "date" }}</div>
            <div>{{ partial "functions/get_event_dates" . }}</div>
          {{ end }}

          {{ if .Params.event }}
            <div class="font-bold text-2xl">{{ i18n "event" }}</div>
            <div>
              {{ with .Params.event_url }}<a href="{{ . }}" target="_blank" rel="noopener">{{ end }}
              {{ .Params.event | markdownify }}
              {{ if .Params.event_url }}</a>{{ end }}
            </div>
          {{ end }}

          {{ if .Params.location }}
            <div class="font-bold text-2xl">{{ i18n "location" }}</div>
            <div>
              <p>{{ .Params.location | markdownify }}</p>
              {{ if .Params.address }}
                <p>{{ partial "functions/get_address" (dict "root" . "address" .Params.address) }}</p>
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ end }}

      <!-- Content body aligned to reference block -->
      <div class="prose prose-slate dark:prose-invert max-w-none">
        {{ .Content }}
      </div>

      {{ partial "components/last-edited.html" . }}

      <div class="prose prose-slate dark:prose-invert mt-5 max-w-none">
        {{ .Scratch.Set "invert_pager" true }}
        {{ partial "page_footer" . }}
      </div>

    </main>
  </article>
</div>
{{ end }}
